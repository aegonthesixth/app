<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MUN Committee Speech Timer</title>
    <style>
        :root {
            /* Modern theme configuration */
            --primary: #6750A4;
            --secondary: #625B71;
            --accent: #7D5260;
            --success: #4CAF50;
            --warning: #FFA726;
            --danger: #F44336;
            
            --bg-primary: #F8F8FC;
            --bg-secondary: #F0F0F6;
            --bg-elevated: #FFFFFF;
            
            --text-primary: #1C1B1F;
            --text-secondary: #49454F;
            --text-disabled: #9E9E9E;
            --text-on-primary: #FFFFFF;
            
            --border: #E0E0E6;
            --highlight: #E8DEF8;
            
            --timer-green: #4CAF50;
            --timer-blue: #03A9F4;
            --timer-orange: #FF9800;
            
            --corner-radius: 8px;
            --border-width: 1px;
            --padding: 10px;
            
            --font-family: 'Segoe UI', system-ui, sans-serif;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-primary);
            margin: 0;
            padding: 0;
            color: var(--text-primary);
        }

        #app {
            width: 100%;
            max-width: 1600px;
            margin: 0 auto;
            min-height: 100vh;
        }

        header {
            background-color: var(--primary);
            color: var(--text-on-primary);
            padding: 15px var(--padding);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 0 0 var(--corner-radius) var(--corner-radius);
        }

        h1 {
            margin: 0;
            font-size: 1.5rem;
        }

        .tabs {
            display: flex;
            background-color: var(--bg-secondary);
            padding: 0 var(--padding);
            margin-top: 10px;
            border-radius: var(--corner-radius) var(--corner-radius) 0 0;
        }

        .tab {
            padding: 12px 16px;
            cursor: pointer;
            background-color: var(--bg-secondary);
            color: var(--text-secondary);
            border: none;
            font-family: var(--font-family);
            font-size: 1rem;
            transition: background-color 0.2s, color 0.2s;
            border-radius: var(--corner-radius) var(--corner-radius) 0 0;
        }

        .tab.active {
            background-color: var(--primary);
            color: var(--text-on-primary);
        }

        .tab:hover:not(.active) {
            background-color: var(--highlight);
        }

        .tab-content {
            display: none;
            padding: var(--padding);
            background-color: var(--bg-elevated);
            border-radius: 0 0 var(--corner-radius) var(--corner-radius);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .tab-content.active {
            display: block;
        }

        .top-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .committee-selector {
            display: flex;
            align-items: center;
        }

        .committee-selector label {
            margin-right: 8px;
        }

        select {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: var(--corner-radius);
            background-color: var(--bg-elevated);
            font-family: var(--font-family);
            color: var(--text-primary);
        }

        .button {
            background-color: var(--primary);
            color: var(--text-on-primary);
            border: none;
            padding: 8px 16px;
            border-radius: var(--corner-radius);
            cursor: pointer;
            font-family: var(--font-family);
            font-size: 0.9rem;
            transition: background-color 0.2s;
            margin: 0 5px;
        }

        .button:hover {
            filter: brightness(1.1);
        }

        .button.success { background-color: var(--success); }
        .button.warning { background-color: var(--warning); }
        .button.danger { background-color: var(--danger); }
        .button.secondary { background-color: var(--secondary); }
        .button.accent { background-color: var(--accent); }

        .columns {
            display: flex;
            gap: 20px;
            margin-top: 15px;
        }

        .column {
            flex: 1;
        }

        .card {
            background-color: var(--bg-elevated);
            border-radius: var(--corner-radius);
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            margin-bottom: 15px;
            overflow: hidden;
        }

        .card-header {
            background-color: var(--primary);
            color: var(--text-on-primary);
            padding: 10px 15px;
            font-weight: bold;
        }

        .card-body {
            padding: 15px;
        }

        .list-container {
            height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: var(--corner-radius);
            background-color: var(--bg-elevated);
        }

        .list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .list-item {
            padding: 8px 15px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
        }

        .list-item:hover {
            background-color: var(--highlight);
        }

        .list-item.selected {
            background-color: var(--primary);
            color: var(--text-on-primary);
        }

        .timer-cards {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .timer-card {
            flex: 1;
            background-color: var(--timer-green);
            color: var(--text-on-primary);
            border-radius: var(--corner-radius);
            padding: 15px;
            text-align: center;
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
        }

        .timer-card:nth-child(2) {
            background-color: var(--timer-blue);
        }

        .timer-card:nth-child(3) {
            background-color: var(--timer-orange);
        }

        .timer-title {
            font-weight: bold;
            margin-bottom: 8px;
        }

        .timer-display {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 10px 0 15px;
        }

        .timer-controls {
            display: flex;
            justify-content: space-around;
        }

        .timer-button {
            background-color: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: var(--corner-radius);
            cursor: pointer;
            font-family: var(--font-family);
            transition: background-color 0.2s;
        }

        .timer-button:hover {
            background-color: rgba(255,255,255,0.3);
        }

        .notes-area {
            width: 100%;
            height: 150px;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: var(--corner-radius);
            font-family: var(--font-family);
            resize: vertical;
            margin-bottom: 10px;
        }

        .note-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        /* Current speaker display */
        .current-speaker {
            text-align: center;
            padding: 20px;
            margin-bottom: 20px;
        }

        .current-speaker-label {
            font-size: 1.2rem;
            color: var(--primary);
            font-weight: bold;
            margin-bottom: 5px;
        }

        .current-speaker-name {
            font-size: 2rem;
            margin: 10px 0 20px;
        }

        /* Speaker list controls */
        .list-controls {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }

        /* For frequency list coloring */
        .frequency-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        /* Messaging layout */
        .messaging-container {
            display: flex;
            height: 500px;
            gap: 15px;
        }

        .delegates-list {
            flex: 1;
            max-width: 300px;
        }

        .messages-container {
            flex: 2;
            display: flex;
            flex-direction: column;
        }

        .messages-list {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 15px;
        }

        .message-compose {
            background-color: var(--bg-elevated);
            padding: 15px;
            border-radius: var(--corner-radius);
            border: 1px solid var(--border);
        }

        .message-input {
            width: 100%;
            min-height: 80px;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: var(--corner-radius);
            font-family: var(--font-family);
            margin-bottom: 10px;
            resize: vertical;
        }

        /* Fun mode styles */
        .fun-mode {
            background-color: #FF5BFF;
            color: white;
            text-align: center;
            padding: 20px;
            border-radius: var(--corner-radius);
        }

        .fun-mode-header {
            font-size: 2.5rem;
            margin-bottom: 20px;
        }

        .fun-timer {
            font-size: 4rem;
            margin: 20px 0;
        }

        .game-options {
            margin: 30px 0;
        }

        .game-option {
            background-color: #FFE6F7;
            color: var(--text-primary);
            margin: 10px auto;
            padding: 15px;
            border-radius: var(--corner-radius);
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 500px;
        }

        /* Role call styles */
        .role-call-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .role-call-modal {
            background-color: var(--bg-elevated);
            width: 80%;
            max-width: 1000px;
            max-height: 80vh;
            border-radius: var(--corner-radius);
            overflow-y: auto;
        }

        .role-call-header {
            background-color: var(--primary);
            color: var(--text-on-primary);
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .role-call-body {
            padding: 15px;
        }

        .role-call-table {
            width: 100%;
            border-collapse: collapse;
        }

        .role-call-table th, .role-call-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .role-call-table th {
            background-color: var(--bg-secondary);
            font-weight: bold;
        }

        .role-call-table tr:nth-child(even) {
            background-color: var(--bg-secondary);
        }

        .dialog {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .dialog-content {
            background-color: var(--bg-elevated);
            padding: 20px;
            border-radius: var(--corner-radius);
            min-width: 300px;
            max-width: 500px;
        }

        .dialog-title {
            margin-top: 0;
            color: var(--primary);
        }

        .dialog-buttons {
            display: flex;
            justify-content: flex-end;
            margin-top: 20px;
            gap: 10px;
        }

        .tab.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        @media (max-width: 768px) {
            .columns {
                flex-direction: column;
            }
            
            .timer-cards {
                flex-direction: column;
            }
            
            .messaging-container {
                flex-direction: column;
            }
            
            .delegates-list {
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <header>
            <h1>MUN Committee Speech Timer</h1>
            <div class="auth-status">
                <span id="auth-username">Not logged in</span>
                <button id="auth-button" class="button secondary">Login with GitHub</button>
            </div>
        </header>

        <div class="tabs">
            <button class="tab active" data-tab="main">Main Dashboard</button>
            <button class="tab" data-tab="speaking-list">Speaking List</button>
            <button class="tab" data-tab="messaging">Messaging</button>
        </div>

        <!-- Main Dashboard Tab -->
        <div id="main-tab" class="tab-content active">
            <div class="top-controls">
                <div class="committee-selector">
                    <label for="committee-select">Committee:</label>
                    <select id="committee-select">
                        <option value="UNSC">UNSC</option>
                        <option value="UNODC">UNODC</option>
                        <option value="UNGA">UNGA</option>
                        <option value="UNHRC">UNHRC</option>
                        <option value="ECOSOC">ECOSOC</option>
                        <option value="WHO">WHO</option>
                    </select>
                </div>
                <div class="control-buttons">
                    <button id="export-button" class="button warning">Export Data</button>
                    <button id="role-call-button" class="button">Role Call</button>
                    <button id="lock-countries-button" class="button secondary">Lock Countries</button>
                </div>
            </div>

            <div class="columns">
                <div class="column">
                    <!-- Country List Card -->
                    <div class="card">
                        <div class="card-header">Countries</div>
                        <div class="card-body">
                            <div class="list-container">
                                <ul id="country-list" class="list"></ul>
                            </div>
                            <button id="add-to-list-button" class="button primary" style="width: 100%; margin-top: 10px;">Add to Speaking List</button>
                        </div>
                    </div>

                    <!-- Frequency List Card -->
                    <div class="card">
                        <div class="card-header">Speaker Frequency</div>
                        <div class="card-body">
                            <div class="list-container">
                                <ul id="frequency-list" class="list"></ul>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="column">
                    <!-- Timers Section -->
                    <div class="card">
                        <div class="card-header">Timers</div>
                        <div class="card-body">
                            <div class="timer-cards">
                                <div class="timer-card">
                                    <div class="timer-title">Session</div>
                                    <div class="timer-display" id="session-timer">00:00</div>
                                    <div class="timer-controls">
                                        <button class="timer-button" data-timer="session" data-action="start">Start</button>
                                        <button class="timer-button" data-timer="session" data-action="stop">Stop</button>
                                        <button class="timer-button" data-timer="session" data-action="reset">Reset</button>
                                    </div>
                                </div>
                                <div class="timer-card">
                                    <div class="timer-title">Caucus</div>
                                    <div class="timer-display" id="caucus-timer">00:00</div>
                                    <div class="timer-controls">
                                        <button class="timer-button" data-timer="caucus" data-action="start">Start</button>
                                        <button class="timer-button" data-timer="caucus" data-action="stop">Stop</button>
                                        <button class="timer-button" data-timer="caucus" data-action="reset">Reset</button>
                                    </div>
                                </div>
                                <div class="timer-card">
                                    <div class="timer-title">Speech</div>
                                    <div class="timer-display" id="speech-timer">00:00</div>
                                    <div class="timer-controls">
                                        <button class="timer-button" data-timer="speech" data-action="start">Start</button>
                                        <button class="timer-button" data-timer="speech" data-action="stop">Stop</button>
                                        <button class="timer-button" data-timer="speech" data-action="reset">Reset</button>
                                    </div>
                                </div>
                            </div>
                            <button id="rearrange-timers-button" class="button secondary" style="width: 100%;">Rearrange Timers</button>
                        </div>
                    </div>

                    <!-- Notes Section -->
                    <div class="card">
                        <div class="card-header">Notes</div>
                        <div class="card-body">
                            <textarea id="notes-area" class="notes-area" placeholder="Enter notes here..."></textarea>
                            <div class="note-buttons">
                                <button class="button success" data-note="Good Speech">Good Speech</button>
                                <button class="button danger" data-note="Bad Speech">Bad Speech</button>
                                <button class="button primary" data-note="Good Diplomacy">Good Diplomacy</button>
                                <button class="button warning" data-note="Bad Diplomacy">Bad Diplomacy</button>
                            </div>
                        </div>
                    </div>

                    <!-- Fun Mode Button -->
                    <button id="fun-mode-button" class="button accent" style="width: 100%;">Fun Committee Mode</button>
                </div>
            </div>
        </div>

        <!-- Speaking List Tab -->
        <div id="speaking-list-tab" class="tab-content">
            <div class="current-speaker">
                <div class="current-speaker-label">Current Speaker</div>
                <div class="current-speaker-name" id="current-speaker-display">None</div>
                <div>
                    <button id="next-speaker-button" class="button success">Next Speaker</button>
                    <button id="skip-speaker-button" class="button danger">Skip Speaker</button>
                </div>
            </div>

            <div class="card">
                <div class="card-header">Speaking List</div>
                <div class="card-body">
                    <div class="list-container" style="height: 400px;">
                        <ul id="speaking-list" class="list"></ul>
                    </div>
                    <div class="list-controls">
                        <button id="move-up-button" class="button primary">Move Up</button>
                        <button id="move-down-button" class="button primary">Move Down</button>
                        <button id="remove-button" class="button danger">Remove</button>
                        <button id="clear-list-button" class="button secondary">Clear List</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Messaging Tab -->
        <div id="messaging-tab" class="tab-content">
            <!-- Authentication Required Panel -->
            <div id="auth-required-panel">
                <div class="card">
                    <div class="card-body" style="text-align: center; padding: 40px 20px;">
                        <h2>GitHub Authentication Required</h2>
                        <p>You need to authenticate with GitHub to access the messaging feature.</p>
                        <button id="auth-messaging-button" class="button primary">Authenticate with GitHub</button>
                    </div>
                </div>
            </div>

            <!-- Messaging Interface (hidden initially) -->
            <div id="messaging-interface" style="display: none;">
                <div class="messaging-container">
                    <div class="delegates-list">
                        <div class="card" style="height: 100%;">
                            <div class="card-header">Delegates</div>
                            <div class="card-body" style="height: calc(100% - 50px); display: flex; flex-direction: column;">
                                <div class="list-container" style="flex: 1;">
                                    <ul id="conversation-list" class="list"></ul>
                                </div>
                                <button id="new-message-button" class="button success" style="margin-top: 10px;">New Message</button>
                            </div>
                        </div>
                    </div>

                    <div class="messages-container">
                        <div class="card" style="flex: 1; margin-bottom: 10px;">
                            <div class="card-header">Messages</div>
                            <div class="card-body" style="height: calc(100% - 50px); overflow-y: auto;">
                                <div id="message-display"></div>
                            </div>
                        </div>

                        <div class="message-compose">
                            <textarea id="message-input" class="message-input" placeholder="Type your message here..."></textarea>
                            <div style="text-align: right;">
                                <button id="send-message-button" class="button primary">Send Message</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Role Call Modal -->
        <div id="role-call-modal" class="role-call-container">
            <div class="role-call-modal">
                <div class="role-call-header">
                    <h2 id="role-call-title">Role Call</h2>
                    <div>
                        <label for="role-call-date">Date:</label>
                        <input type="text" id="role-call-date" placeholder="YYYY-MM-DD">
                        <button id="add-date-button" class="button primary">Add Date</button>
                        <button id="close-role-call-button" class="button">Close</button>
                    </div>
                </div>
                <div class="role-call-body">
                    <table id="role-call-table" class="role-call-table">
                        <thead>
                            <tr>
                                <th>Country</th>
                                <!-- Dates will be inserted dynamically -->
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Countries and attendance will be inserted dynamically -->
                        </tbody>
                    </table>
                    <div style="text-align: right; margin-top: 15px;">
                        <button id="save-role-call-button" class="button success">Save Role Call</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- New Message Dialog -->
        <div id="new-message-dialog" class="dialog">
            <div class="dialog-content">
                <h3 class="dialog-title">New Message</h3>
                <div>
                    <label for="recipient-select">To:</label>
                    <select id="recipient-select" style="width: 100%; margin-bottom: 15px;"></select>
                </div>
                <div>
                    <label for="new-message-text">Message:</label>
                    <textarea id="new-message-text" class="message-input"></textarea>
                </div>
                <div class="dialog-buttons">
                    <button id="cancel-message-button" class="button secondary">Cancel</button>
                    <button id="send-new-message-button" class="button primary">Send</button>
                </div>
            </div>
        </div>

        <!-- Fun Mode Container (hidden initially) -->
        <div id="fun-mode-container" style="display: none;">
            <div class="fun-mode">
                <div class="fun-mode-header">Fun Committee Mode</div>
                <div class="fun-timer" id="fun-timer">00:00</div>
                <div>
                    <button class="button" style="background-color: #6A0DAD;" data-action="start-fun">Start</button>
                    <button class="button" style="background-color: #6A0DAD;" data-action="stop-fun">Stop</button>
                    <button class="button" style="background-color: #6A0DAD;" data-action="reset-fun">Reset</button>
                </div>

                <div class="game-options">
                    <div class="game-option">
                        <span>UN Charades - Votes: <span class="vote-count">0</span></span>
                        <button class="button primary vote-button">Vote</button>
                    </div>
                    <div class="game-option">
                        <span>Diplomatic Trivia - Votes: <span class="vote-count">0</span></span>
                        <button class="button primary vote-button">Vote</button>
                    </div>
                    <div class="game-option">
                        <span>Resolution Writing Race - Votes: <span class="vote-count">0</span></span>
                        <button class="button primary vote-button">Vote</button>
                    </div>
                    <div class="game-option">
                        <span>Crisis Simulation - Votes: <span class="vote-count">0</span></span>
                        <button class="button primary vote-button">Vote</button>
                    </div>
                </div>

                <button id="exit-fun-mode-button" class="button danger">Exit Fun Mode</button>
            </div>
        </div>
    </div>

    <script>
// Helper function to generate UUIDs
function generateUUID() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        const r = Math.random() * 16 | 0;
        const v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
    });
}

// Initialize the application when the DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    console.log("DOM loaded - initializing MUN Timer App");
    
    // Tab switching functionality
    function setupTabSwitching() {
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                if (tab.classList.contains('disabled')) return;
                
                const tabId = tab.getAttribute('data-tab');
                
                // Update active tab
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // Show corresponding content
                tabContents.forEach(content => {
                    content.classList.remove('active');
                    if (content.id === `${tabId}-tab`) {
                        content.classList.add('active');
                    }
                });
            });
        });
    }
    
    // Global data and state
    const state = {
        currentSpeaker: null,
        speakerQueue: [],
        delegateData: {},
        attendanceData: {},
        attendanceDates: [],
        isCountryListLocked: false,
        selectedCommittee: 'UNSC',
        authenticatedUsername: null,
        messages: [],
        delegates: new Set(),
        selectedDelegate: null,
        timerIntervals: {
            session: null,
            caucus: null,
            speech: null,
            fun: null
        },
        timerStart: {
            session: 0,
            caucus: 0,
            speech: 0,
            fun: 0
        },
        timerElapsed: {
            session: 0,
            caucus: 0,
            speech: 0,
            fun: 0
        },
        timerRunning: {
            session: false,
            caucus: false,
            speech: false,
            fun: false
        },
        timerTypes: ["Session", "Caucus", "Speech"],
        timerColors: ["var(--timer-green)", "var(--timer-blue)", "var(--timer-orange)"]
    };

    // Initialize countries for committees
    const committeeCountries = {
        'UNSC': ['USA', 'UK', 'France', 'Russia', 'China', 'India', 'Brazil', 'Japan', 'Germany', 'South Africa', 'Kenya', 'Ghana'],
        'UNODC': ['USA', 'Canada', 'Mexico', 'Brazil', 'Colombia', 'UK', 'France', 'Germany', 'Russia', 'China', 'Japan', 'India', 'Nigeria', 'South Africa'],
        'UNGA': ['USA', 'UK', 'France', 'Russia', 'China', 'India', 'Germany', 'Japan', 'Brazil', 'South Africa', 'Egypt', 'Saudi Arabia', 'Australia', 'Canada'],
        'UNHRC': ['USA', 'UK', 'Germany', 'France', 'Italy', 'Argentina', 'Brazil', 'Japan', 'South Korea', 'India', 'South Africa', 'Kenya', 'Morocco'],
        'ECOSOC': ['USA', 'China', 'Russia', 'UK', 'France', 'Germany', 'India', 'Brazil', 'Japan', 'South Africa', 'Nigeria', 'Egypt', 'Saudi Arabia'],
        'WHO': ['USA', 'UK', 'France', 'Germany', 'Japan', 'China', 'India', 'Brazil', 'South Africa', 'Kenya', 'Australia', 'Canada', 'Mexico']
    };

    // Updated timer functions
function formatTime(timeInSeconds) {
    const minutes = Math.floor(timeInSeconds / 60).toString().padStart(2, '0');
    const seconds = (timeInSeconds % 60).toString().padStart(2, '0');
    return `${minutes}:${seconds}`;
}

function updateTimerDisplay(timerType) {
    const display = document.getElementById(`${timerType.toLowerCase()}-timer`);
    if (display) {
        display.textContent = formatTime(state.timerElapsed[timerType.toLowerCase()]);
    }
}

function startTimer(timerType) {
    const lowerType = timerType.toLowerCase();
    
    // Stop any running timer first to ensure clean state
    stopTimer(timerType);
    
    // Set running state
    state.timerRunning[lowerType] = true;
    state.timerStart[lowerType] = Date.now() - (state.timerElapsed[lowerType] * 1000);
    
    // Create new interval
    state.timerIntervals[lowerType] = setInterval(() => {
        const currentTime = Date.now();
        state.timerElapsed[lowerType] = Math.floor((currentTime - state.timerStart[lowerType]) / 1000);
        updateTimerDisplay(timerType);
    }, 200); // More frequent updates for smoother display
    
    console.log(`Started ${timerType} timer`);
}

function stopTimer(timerType) {
    const lowerType = timerType.toLowerCase();
    
    // Always clear interval, even if we think it's not running
    if (state.timerIntervals[lowerType]) {
        clearInterval(state.timerIntervals[lowerType]);
        state.timerIntervals[lowerType] = null;
    }
    
    state.timerRunning[lowerType] = false;
    console.log(`Stopped ${timerType} timer`);
}

function resetTimer(timerType) {
    const lowerType = timerType.toLowerCase();
    stopTimer(timerType);
    state.timerElapsed[lowerType] = 0;
    updateTimerDisplay(timerType);
    console.log(`Reset ${timerType} timer`);
}

    // Function to populate country list
    function populateCountryList(committee) {
        const countryList = document.getElementById('country-list');
        if (!countryList) return;
        
        countryList.innerHTML = '';
        
        if (!committeeCountries[committee]) {
            console.error(`Committee ${committee} not found in committeeCountries`);
            return;
        }
        
        committeeCountries[committee].forEach(country => {
            const li = document.createElement('li');
            li.textContent = country;
            li.className = 'list-item';
            li.addEventListener('click', function() {
                document.querySelectorAll('#country-list .list-item').forEach(item => {
                    item.classList.remove('selected');
                });
                this.classList.add('selected');
            });
            countryList.appendChild(li);
        });
        
        console.log(`Populated country list for ${committee} with ${committeeCountries[committee].length} countries`);
    }

    // Function to add a country to the speaking list
    function addToSpeakingList(country) {
        if (!country) {
            console.error("Attempted to add undefined country to speaking list");
            return;
        }
        
        state.speakerQueue.push(country);
        
        // Update frequency data
        if (!state.delegateData[country]) {
            state.delegateData[country] = {
                speaking: 0,
                votes: 0,
                notes: []
            };
        }
        state.delegateData[country].speaking++;
        
        console.log(`Added ${country} to speaking list`);
    }

    // Function to update speaking list display
    function updateSpeakingList() {
        const speakingList = document.getElementById('speaking-list');
        if (!speakingList) return;
        
        speakingList.innerHTML = '';
        
        state.speakerQueue.forEach((country, index) => {
            const li = document.createElement('li');
            li.textContent = country;
            li.className = 'list-item';
            li.dataset.index = index;
            li.addEventListener('click', function() {
                document.querySelectorAll('#speaking-list .list-item').forEach(item => {
                    item.classList.remove('selected');
                });
                this.classList.add('selected');
            });
            speakingList.appendChild(li);
        });
        
        console.log(`Updated speaking list with ${state.speakerQueue.length} countries`);
    }

    // Function to update frequency list
    function updateFrequencyList() {
        const frequencyList = document.getElementById('frequency-list');
        if (!frequencyList) return;
        
        frequencyList.innerHTML = '';
        
        // Create array from delegate data
        const delegates = Object.keys(state.delegateData).map(country => {
            return {
                country: country,
                count: state.delegateData[country].speaking
            };
        });
        
        // Sort by speaking count descending
        delegates.sort((a, b) => b.count - a.count);
        
        delegates.forEach(delegate => {
            const li = document.createElement('li');
            li.className = 'list-item';
            
            // Determine color based on frequency
            let colorClass = '';
            if (delegate.count > 5) {
                colorClass = 'background-color: var(--danger);';
            } else if (delegate.count > 3) {
                colorClass = 'background-color: var(--warning);';
            } else if (delegate.count > 0) {
                colorClass = 'background-color: var(--success);';
            }
            
            li.innerHTML = `<span class="frequency-indicator" style="${colorClass}"></span>${delegate.country} - ${delegate.count}`;
            frequencyList.appendChild(li);
        });
    }

    function generateRoleCallTable() {
        const table = document.getElementById('role-call-table');
        if (!table) return;
        
        const headerRow = table.querySelector('thead tr');
        if (!headerRow) return;
        
        // Clear existing header cells except first one
        while (headerRow.children.length > 1) {
            headerRow.removeChild(headerRow.lastChild);
        }
        
        // Add date headers
        state.attendanceDates.forEach(date => {
            const th = document.createElement('th');
            th.textContent = date;
            headerRow.appendChild(th);
        });
        
        // Clear existing body rows
        const tbody = table.querySelector('tbody');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        
        // Add country rows
        const countries = committeeCountries[state.selectedCommittee];
        countries.forEach(country => {
            const tr = document.createElement('tr');
            
            const td = document.createElement('td');
            td.textContent = country;
            tr.appendChild(td);
            
            // Add attendance cells
            state.attendanceDates.forEach(date => {
                const td = document.createElement('td');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                
                // Check if attendance data exists
                if (state.attendanceData[country] && state.attendanceData[country][date]) {
                    checkbox.checked = true;
                }
                
                // Add change event
                checkbox.addEventListener('change', function() {
                    if (!state.attendanceData[country]) {
                        state.attendanceData[country] = {};
                    }
                    state.attendanceData[country][date] = this.checked;
                });
                
                td.appendChild(checkbox);
                tr.appendChild(td);
            });
            
            tbody.appendChild(tr);
        });
    }

    // Set up the application
    function initializeApp() {
        // Initialize with default committee
        populateCountryList(state.selectedCommittee);

        // Initialize timer displays
        updateTimerDisplay('session');
        updateTimerDisplay('caucus');
        updateTimerDisplay('speech');
        updateTimerDisplay('fun');
        
        // Setup tab switching
        setupTabSwitching();
        
        // Setup event listeners for all buttons and interactive elements
        setupEventListeners();
        
        console.log("MUN Committee Timer App initialized successfully");
    }

    // Setup all event listeners
    function setupEventListeners() {
        // Helper to safely add event listener
        function addSafeEventListener(id, event, callback) {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener(event, callback);
                return true;
            } else {
                console.warn(`Element with id ${id} not found for event listener`);
                return false;
            }
        }
        
        // Handle committee selection change
        addSafeEventListener('committee-select', 'change', function() {
            state.selectedCommittee = this.value;
            populateCountryList(state.selectedCommittee);
            updateFrequencyList();
        });

        // Add to speaking list button
        addSafeEventListener('add-to-list-button', 'click', function() {
            const selectedCountry = document.querySelector('#country-list .list-item.selected');
            if (selectedCountry) {
                const country = selectedCountry.textContent;
                addToSpeakingList(country);
                updateSpeakingList();
                updateFrequencyList();
            } else {
                console.log("No country selected to add to speaking list");
            }
        });

        // Add event listeners for timer buttons
        // Updated timer button event listeners
document.querySelectorAll('.timer-button').forEach(button => {
    button.addEventListener('click', function(event) {
        // Prevent default to be safe
        event.preventDefault();
        
        const timer = this.getAttribute('data-timer');
        const action = this.getAttribute('data-action');
        
        console.log(`Timer button clicked: ${timer} - ${action}`);
        
        if (action === 'start') {
            startTimer(timer);
        } else if (action === 'stop') {
            stopTimer(timer);
        } else if (action === 'reset') {
            resetTimer(timer);
        }
    });
});

        // Next speaker button
        addSafeEventListener('next-speaker-button', 'click', function() {
            if (state.speakerQueue.length > 0) {
                if (state.currentSpeaker) {
                    // Current speaker is done
                    resetTimer('speech');
                }
                
                // Get next speaker
                state.currentSpeaker = state.speakerQueue.shift();
                const currentSpeakerDisplay = document.getElementById('current-speaker-display');
                if (currentSpeakerDisplay) {
                    currentSpeakerDisplay.textContent = state.currentSpeaker;
                }
                
                // Start speech timer
                resetTimer('speech');
                startTimer('speech');
                
                // Update the display
                updateSpeakingList();
            } else {
                console.log("No speakers in queue");
            }
        });

        // Skip speaker button
        addSafeEventListener('skip-speaker-button', 'click', function() {
            if (state.currentSpeaker) {
                resetTimer('speech');
                state.currentSpeaker = null;
                
                const currentSpeakerDisplay = document.getElementById('current-speaker-display');
                if (currentSpeakerDisplay) {
                    currentSpeakerDisplay.textContent = 'None';
                }
                
                if (state.speakerQueue.length > 0) {
                    state.currentSpeaker = state.speakerQueue.shift();
                    if (currentSpeakerDisplay) {
                        currentSpeakerDisplay.textContent = state.currentSpeaker;
                    }
                    resetTimer('speech');
                    startTimer('speech');
                }
                
                updateSpeakingList();
            }
        });

        // Speaking list controls
        addSafeEventListener('move-up-button', 'click', function() {
            const selected = document.querySelector('#speaking-list .list-item.selected');
            if (selected) {
                const index = parseInt(selected.dataset.index);
                if (index > 0) {
                    // Swap with previous item
                    [state.speakerQueue[index], state.speakerQueue[index - 1]] = [state.speakerQueue[index - 1], state.speakerQueue[index]];
                    updateSpeakingList();
                    
                    // Keep the item selected
                    const items = document.querySelectorAll('#speaking-list .list-item');
                    if (items.length > index - 1) {
                        items[index - 1].classList.add('selected');
                    }
                }
            }
        });

        addSafeEventListener('move-down-button', 'click', function() {
            const selected = document.querySelector('#speaking-list .list-item.selected');
            if (selected) {
                const index = parseInt(selected.dataset.index);
                if (index < state.speakerQueue.length - 1) {
                    // Swap with next item
                    [state.speakerQueue[index], state.speakerQueue[index + 1]] = [state.speakerQueue[index + 1], state.speakerQueue[index]];
                    updateSpeakingList();
                    
                    // Keep the item selected
                    const items = document.querySelectorAll('#speaking-list .list-item');
                    if (items.length > index + 1) {
                        items[index + 1].classList.add('selected');
                    }
                }
            }
        });

        addSafeEventListener('remove-button', 'click', function() {
            const selected = document.querySelector('#speaking-list .list-item.selected');
            if (selected) {
                const index = parseInt(selected.dataset.index);
                state.speakerQueue.splice(index, 1);
                updateSpeakingList();
            }
        });

        addSafeEventListener('clear-list-button', 'click', function() {
            state.speakerQueue = [];
            updateSpeakingList();
        });

        // Notes functionality
        document.querySelectorAll('.note-buttons .button').forEach(button => {
            button.addEventListener('click', function() {
                const noteText = this.getAttribute('data-note');
                const notesArea = document.getElementById('notes-area');
                
                if (state.currentSpeaker && notesArea) {
                    const timestamp = new Date().toLocaleTimeString();
                    const note = `[${timestamp}] ${state.currentSpeaker}: ${noteText}`;
                    
                    // Add to text area
                    notesArea.value += (notesArea.value ? '\n' : '') + note;
                    
                    // Add to delegate data
                    if (!state.delegateData[state.currentSpeaker]) {
                        state.delegateData[state.currentSpeaker] = {
                            speaking: 0,
                            votes: 0,
                            notes: []
                        };
                    }
                    state.delegateData[state.currentSpeaker].notes.push({
                        timestamp: timestamp,
                        note: noteText
                    });
                }
            });
        });

        // Lock countries functionality
        addSafeEventListener('lock-countries-button', 'click', function() {
            state.isCountryListLocked = !state.isCountryListLocked;
            
            const countryListItems = document.querySelectorAll('#country-list .list-item');
            if (state.isCountryListLocked) {
                this.textContent = 'Unlock Countries';
                countryListItems.forEach(item => {
                    item.style.pointerEvents = 'none';
                    item.style.opacity = '0.6';
                });
            } else {
                this.textContent = 'Lock Countries';
                countryListItems.forEach(item => {
                    item.style.pointerEvents = 'auto';
                    item.style.opacity = '1';
                });
            }
        });

        // Fun Mode functionality
        addSafeEventListener('fun-mode-button', 'click', function() {
            const appElement = document.getElementById('app');
            const funModeContainer = document.getElementById('fun-mode-container');
            
            if (appElement && funModeContainer) {
                appElement.style.display = 'none';
                funModeContainer.style.display = 'block';
                resetTimer('fun');
            }
        });

        addSafeEventListener('exit-fun-mode-button', 'click', function() {
            const appElement = document.getElementById('app');
            const funModeContainer = document.getElementById('fun-mode-container');
            
            if (appElement && funModeContainer) {
                appElement.style.display = 'block';
                funModeContainer.style.display = 'none';
                stopTimer('fun');
            }
        });

        // Fun mode timer controls
        const startFunButton = document.querySelector('[data-action="start-fun"]');
        if (startFunButton) {
            startFunButton.addEventListener('click', function() {
                startTimer('fun');
            });
        }

        const stopFunButton = document.querySelector('[data-action="stop-fun"]');
        if (stopFunButton) {
            stopFunButton.addEventListener('click', function() {
                stopTimer('fun');
            });
        }

        const resetFunButton = document.querySelector('[data-action="reset-fun"]');
        if (resetFunButton) {
            resetFunButton.addEventListener('click', function() {
                resetTimer('fun');
            });
        }

        // Fun mode voting
        document.querySelectorAll('.vote-button').forEach(button => {
            button.addEventListener('click', function() {
                const voteCount = this.parentElement.querySelector('.vote-count');
                if (voteCount) {
                    const currentCount = parseInt(voteCount.textContent);
                    voteCount.textContent = currentCount + 1;
                }
            });
        });

        // Role Call functionality
        addSafeEventListener('role-call-button', 'click', function() {
            generateRoleCallTable();
            const roleCallModal = document.getElementById('role-call-modal');
            if (roleCallModal) {
                roleCallModal.style.display = 'flex';
            }
        });

        addSafeEventListener('close-role-call-button', 'click', function() {
            const roleCallModal = document.getElementById('role-call-modal');
            if (roleCallModal) {
                roleCallModal.style.display = 'none';
            }
        });

        addSafeEventListener('add-date-button', 'click', function() {
            const dateInput = document.getElementById('role-call-date');
            if (!dateInput) return;
            
            const date = dateInput.value.trim();
            
            if (date && !state.attendanceDates.includes(date)) {
                state.attendanceDates.push(date);
                generateRoleCallTable();
            }
            
            dateInput.value = '';
        });

        addSafeEventListener('save-role-call-button', 'click', function() {
            // In a real app, this would save to a database
            alert('Role call data saved successfully!');
        });

        // Export data functionality
        addSafeEventListener('export-button', 'click', function() {
            const exportData = {
                committee: state.selectedCommittee,
                delegateData: state.delegateData,
                attendanceData: state.attendanceData,
                attendanceDates: state.attendanceDates,
                currentTime: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `MUN_${state.selectedCommittee}_data.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        });

        // Rearrange Timers functionality
        addSafeEventListener('rearrange-timers-button', 'click', function() {
            // Rotate timer colors
            state.timerColors.unshift(state.timerColors.pop());
            
            // Apply new colors
            document.querySelectorAll('.timer-card').forEach((card, index) => {
                card.style.backgroundColor = state.timerColors[index];
            });
        });
    }

    // Call the initialization function
    initializeApp();
});
</script>            
